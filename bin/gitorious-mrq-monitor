#!/usr/bin/env python2

import optparse, sys, string, random

from twisted.internet import reactor

from gitorious_mrq import ircbot


if __name__ == "__main__":

    usage = '%prog [options] FEED_URL'
    parser = optparse.OptionParser()

    # Options for IRC
    parser.add_option('', "--irc-server", default='irc.freenode.net',
                      help="The server to connect IRC bot to.")
    parser.add_option('', "--irc-port", default=6667,
                      help="The port to use for IRC bot.")
    parser.add_option('', "--irc-channel", default='#gitorious-mrq-monitor-test',
                      help="The channel to join for IRC bot.")
    parser.add_option('', "--irc-nick", default='autogenerated',
                      help="The nick to use for IRC bot.")

    (options, args) = parser.parse_args()

    if len(args) != 1:
        parser.error('The feed URL must be specified. Example: https://gitorious.org/gitorious.atom')

    feed_url = args[0]
    
    if options.irc_nick == 'autogenerated':
        options.irc_nick = 'mrq-%s' % ''.join([random.choice(string.hexdigits) for x in range(5)])

    f = ircbot.IrcBotFactory(options.irc_channel, options.irc_nick, [feed_url])
    reactor.connectTCP(options.irc_server, options.irc_port, f)

    reactor.run()
